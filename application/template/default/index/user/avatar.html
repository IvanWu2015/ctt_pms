<div class="modalwrap h350 sizing" style="width:450px;" id="modalwrap">
    <form action="" method="post" id="add_tag"  enctype="multipart/form-data">
    <h3 class="modaltitle pl15 pr15 sizing" id="modaltitle">修改头像<a href="javascript:void(0);" onClick="modalclose();" class="y fs13 iconfont">&#xe61c;</a></h3>
    <div class="publocdiv pl20 pr20 sizing modalcontnet h230">
        
        <div class="imgwrap mb15 mt20" id="imgwrap" style="margin-left:120px;">
            <input type="file" id="cover_image" class="cover" name="avatar" />
            <input type="hidden" id="cover_image_url" class="cover" name="avatar" />
            <img src="" id="coverimg" />
        </div>
        <p class="mbn c6 ac">头像大小建议为700*700像素</p>
        <p class="mbn c6 ac">支持格式：jpg,jpeg,png,gif,bmp</p>
        
    </div>
    <div class="modalbottom pt8 pb8 pl15 pr15 sizing">
        <a href="javascript:void(0);" class="modalsearch bor pl20 pr20 y" onClick="modalsearch();">提交</a>
    </div>
    </form>
</div>

<script>
jQuery(function(){
    if (jQuery('#coverimg').attr('src') == "") {    //封面为空则显示默认图片
        jQuery('#coverimg').attr('src', 'tpl_img/coverimg.png');
    }
    
    //修改头像
    
    jQuery("#cover_image").change(function () {
        var objUrl = getObjectURL(this.files[0]);
        console.log("objUrl = " + objUrl);
        if (objUrl) {
            jQuery("#coverimg").attr("src", objUrl);
            jQuery.ajaxFileUpload({
                type: 'post',
                url: "{:url('/index/mycenter/upload')}",
                secureuri: false,
                fileElementId: 'cover_image',   //文件域ID
                dataType: 'json',
                success: function (data) {
                    if(data.error) {
                        jQuery('#addpr').html(data.error).show(1).delay(2000).hide(1);
                    } else {
                        jQuery("#cover_image_url").val(data.url);
                    }
                }
            });
            
        }
    });
    
});

function modalsearch(){     //ajax提交
    var url="{:url('/index/mycenter/upload')}";
    jQuery.ajax({
        type: 'post',
        url: url,
        data: jQuery('#add_tag').serialize(),
        dataType: 'json',
        success: function (data) {
            if (data.result == 'success') {
                jQuery('#addpr').html('操作成功！').show(1).delay(2000).hide(1);
                modalclose();
                setTimeout("location.reload()",2500);
            }else{
                jQuery('#addpr').html(data.error).show(1).delay(2000).hide(1);
            }
        }
    });
}

//建立一個可存取到該file的url
function getObjectURL(file) {
    var url1 = null;
    if (window.createObjectURL != undefined) { // basic
        url1 = window.createObjectURL(file);
    } else if (window.URL != undefined) { // mozilla(firefox)
        url1 = window.URL.createObjectURL(file);
    } else if (window.webkitURL != undefined) { // webkit or chrome
        url1 = window.webkitURL.createObjectURL(file);
    }
    return url1;
}
</script>